# 7.1.1

~$ vim app/views/layouts/application.html.erb

    <%= render 'layouts/footer' %>
    <% debug(params) if Rails.env.development? %>

# 7.1.2

~$ vim config/routes.rb

    resources :users

Bu haliyle `http://192.168.56.105:3000/users/1` tıklandığında
aşağıda ki hata mesajı üretilir,

    Unknown action
    The action 'show' could not be found for UsersController

ilk aşama viewer tasarımı,

~$ vim app/viewes/users/show.html.erb

    <%= @user.name %>, <%= @user.email %>

bu ise `@user` ve onun üyeleri yokturdan şikayetçi, haklı çünkü
bu değişken henüz set edilmemiş. Bunu ayarlayacak olan ise
controller

~$ vim app/controllers/users_controller.rb

  def show
    @user = User.find(params[:id])
  end

yani url'den gelen show isteğine yanıt ver, argüman/parametre olarak
url'den zaten id gelecek onu da `params` üzerinden çek ve db'de ara.

Bunun için en azından bir tane kullanıcının eklenmiş olması şart,

~$ rails c
>> User.create(name:"nm", email:"e@ma.il", password:"pass",
>> password_confirmation:"pass")

Tekrardan url'den http://192.168.56.105:3000/users/1 isteyin

  ...
  --- !ruby/hash:ActiveSupport::HashWithIndifferentAccess
  action: show
  controller: users
  id: '1'

göreceksiniz.

~$ vim spec/requests/user_pages_spec.rb

        describe "profile page" do # Code to make a user variable before { visit user_path(user) } it { should have_selector('h1', text: user.name) } it { should have_selector('title', text: user.name) } end

Bu haliyle test başarısız olacak.

~$ vim Gemfile

        gem 'factory_girl_rails', '1.4.0'

~$ bundle

~$ vim spec/factories.rb
  FactoryGirl.define do
    factory :user do
      name     "Michael Hartl"
      email    "michael@example.com"
      password "foobar"
    end
  end

~$ vim spec/requests/user_pages_spec.rb

        let(:user) { FactoryGirl.create(:user) }

ekle.

~$ bundle exec rspec spec/
BAŞARISIZ

çözmek için

~$ vim app/views/users/show.html.erb
  % provide :title, @user.name %>
  <h1><%= @user.name %></h1>

~$ vim config/environments/test.rb
  require 'bcrypt'
    silence_warnings do
        BCrypt::Engine::DEFAULT_COST = BCrypt::Engine::MIN_COST
    end

# 7.1.4

~$ vim app/views/users/show.html.erb

  <%= gravatar_for @user %>

~$ bundle exec rspec spec/
hata mesajı...
  require bcrypt

bu yüzden
~$ sudo apt-get install bcrypt

~$ bundle exec rspec spec/
BAŞARISIZ

çünkü `gravatar_for` işlevi tanımsız. Bu işlevi ise helper'a koyacağız,

~$ vim app/helpers/users_helper.rb

  # Returns the Gravatar (http://gravatar.com/) for the given user.
  def gravatar_for(user)
    gravatar_id = Digest::MD5::hexdigest(user.email.downcase)
    gravatar_url = "http://gravatar.com/avatar/#{gravatar_id}.png"
    image_tag(gravatar_url, alt: user.name, class: "gravatar")
  end

~$ bundle exec rspec spec/
BAŞARILI

ve url olarak http://192.168.56.105:3000/users/1 girildiğinde profil
resmi görülebiliyor.

Gravatar tamam, şimdi sidebar'a geçiyoruz.

~$ vim app/views/users/show.html.erb

<table class="profile">
  <tr>
    <td class="main">
      <h1>
        <%= gravatar_for @user %>
        <%= @user.name %>
      </h1>
    </td>
    <td class="sidebar round">
      <strong>Name</strong> <%= @user.name %><br />
      <strong>URL</strong>  <%= link_to user_path(@user), @user %>
    </td>
  </tr>
</table>

url http://192.168.56.105:3000/users/1 girildiğinde herşey yolunda yan bar ortaya çıktı.

Biraz görsellik katalım.

~$ vim app/assets/stylesheets/layout.sass
  /* User show page */
  table.profile
    width: 100%
    margin-bottom: 0

    img:gravatar
      border: 1px solid #999
      margin-bottom: -15 px

  td.main
    width: 70%
    padding: 1em

  td.sidebar
    width: 30%
    padding: 1em
    vertical-align: top
    background: #ffc

# 7.2

http://192.168.56.105:3000/signup şimdilik boş.

Önce console da oluşturulan verileri silelim her şey webden olsun istiyoruz.

~$ bundle exec rake db:reset

test'te buna uygun olsun

~$ bundle exec rake db:test:prepare

şimdi sigup formunun testlerini yazalım (capybara süpermiş ;))

~$ vim spec/requests/user_pages_spec.rb

  describe "signup" do

    before { visit signup_path }

    describe "with invalid information" do
      it "should not create a user" do
        expect { click_button "Sign up" }.not_to change(User, :count)
      end
    end

    describe "with valid information" do
      before do
        fill_in "Name",         with: "Example User"
        fill_in "Email",        with: "user@example.com"
        fill_in "Password",     with: "foobar"
        fill_in "Confirmation", with: "foobar"
      end

      it "should create a user" do
        expect { click_button "Sign up" }.to change(User, :count).by(1)
      end
    end
  end

~$ bundle exec rspec spec/
BAŞARISIZ

view tarafında henüz formumuz hazır değil.

~$ vim app/views/users/new.html.erb

<%= form_for(@user) do |f| %>
  <div class="field">
    <%= f.label :name %><br />
    <%= f.text_field :name %>
  </div>
  <div class="field">
    <%= f.label :email %><br />
    <%= f.text_field :email %>
  </div>
  <div class="field">
    <%= f.label :password %><br />
    <%= f.password_field :password %>
  </div>
  <div class="field">
    <%= f.label :password_confirmation, "Confirmation" %><br />
    <%= f.password_field :password_confirmation %>
  </div>
  <div class="actions">
    <%= f.submit "Sign up" %>
  </div>
<% end %>

bu sadece view ekledi. url ye girmeye çalışırsanız http://192.168.56.105:3000/signup
controller ile alakalı hata mesajları alırsınız.

~$ bundle exec rspec spec/requests/user_pages_spec.rb -e "signup page"
BAŞARISIZ

controller'u tasarlayalım,

~$ vim app/controllers/users_controller.rb

   @user = User.new

artık `@user` da sağlandığından http://192.168.56.105:3000/signup adresinde form gözükür.

~$ bundle exec rspec spec/requests/user_pages_spec.rb -e "signup page"
BAŞARILI

Görsellik zayıf. Buna bakalım,

~$ vim app/assets/stylesheets/layout.sass

  div.field, div.actions {
    margin-bottom: 10px;
  }

görsellikte çok büyük değişiklik henüz yok. http://192.168.56.105:3000/signup bakınız.

Form doldurulup, kaydedilmeye çalışılınca hatayla karşılaşılıyor

  Unknown action
  The action 'create' could not be found for UsersController

haklı değil mi controller da `create` yöntemi henüz tanımlı değil. Nasıl davranacağını
bilmiyor.

~$ vim app/controllers/users_controller.rb
  def create
    @user = User.new(params[:user])
    if @user.save
      # Handle a successful save.
    else
      render 'new'
    end
  end

form doldurulup, butona tıklanırsa alt kısımda,

--- !ruby/hash:ActiveSupport::HashWithIndifferentAccess
utf8: ✓
authenticity_token: GEKJrIp4y+8V6BZti3jJpBQmosXHxT1v/eSsoUoyO5E=
user: !ruby/hash:ActiveSupport::HashWithIndifferentAccess
  name: seyyah
  email: seyyah@bil.omu.edu.tr
  password: secret
  password_confirmation: secret
commit: Sign up
action: create
controller: users

alınıyor ki bu her şeyin yolunda olduğunu gösteriyor. Diğer taraftan
normalde /users a yönlendiriyor fakat buna dair view+controller tanımsız
olduğundan hata mesajı alınıyor. Ayrıca console üzerinden db'den sorguda çekilebilir,

~$ rails c
>> User.all

Daha önceden tanımlandığından http://192.168.56.105:3000/users/1 adresinden tanımlanan
girilen kullanıcı ayrıntıları görülebilir.

# 7.3.2

Email ve kısa parola save etme sırasında başarısızlığa yol açar,

~$ rails console
>> user = User.new(name: "Foo Bar", email: "foo@invalid",
?>                 password: "dude", password_confirmation: "dude")
>> user.save
=> false
>> user.errors.full_messages
=> ["Email is invalid", "Password is too short (minimum is 6 characters)"]

Bu hata mesajlarını kayıt/sign up formunda göstermek gerekir ki kullanıcı hatasını anlasın.
view kısmında aşağıda ki eklentiye bakar,

~$ vim app/views/users/new.html.erb
        <%= render 'shared/error_messages' %>

fakat henüz shared/ klasörü yoktur ve onun altında error_messages zaten yok. o yüzden hata mesajları
alırız.

Bunu idare etmek için app/views/shared klasörü oluşturulup içerisine `_error_messages.html.erb`
dosyası eklenecek.

~$ mkdir app/views/shared/
~$ vim app/views/shared/_error_messages.html.erb

<% if @user.errors.any? %>
  <div id="error_explanation">
    <h2><%= pluralize(@user.errors.count, "error") %>
        prohibited this user from being saved:</h2>
    <p>There were problems with the following fields:</p>
    <ul>
    <% @user.errors.full_messages.each do |msg| %>
      <li><%= msg %></li>
    <% end %>
    </ul>
  </div>
<% end %>

url'de http://192.168.140.182:3000/signup girildiğinde bir hata mesajı alınmaz. Form doldurulup hatalar
yapıldığında aşağıda kine benzer bir mesaj alırız,

  2 errors prohibited this user from being saved:

  There were problems with the following fields:

  Email is invalid
  Password is too short (minimum is 6 characters)

Görsel olarak ayrımını sağlamak için CSS/SASS eklentisi,

~$ vim app/assets/stylesheets/layout.sass
.field_with_errors {
  margin-top: 10px;
  padding: 2px;
  ...

Test başarılı olacaktır

~$ bundle exec rspec spec/requests/user_pages_spec.rb -e "signup with invalid information"
BAŞARILI

Fakat ev-ofis geçişleri github üzerinden yapılırken veritabanının tekrardan oluşturması gerekecektir

        $ rake db:reset
        $ rake db:migrate
        $ rake db:test:prepare

# 7.4.1 The finished signup form

Şu aşamada aşağıda ki test başarısızdır,

~$ bundle exec rspec spec/requests/user_pages_spec.rb \
> -e "signup with valid information"
BAŞARISIZ

Bunun sebebi `create` işleminde başarılı save'in idare edilmemesinden kaynaklı,

~$ vim app/controllers/users_controller.rb
if @user.save
        # Handle a successful save.

doğrusu şöyle olmalıdır,

        redirect_to @user

artık testler başarılı sonuç üretmelidir.

~$ bundle exec rspec spec/
BAŞARILI

# 7.4.2 The flash

Tamam güzel de kullanıcıya başarılı olduğunu da bildirelim. ama nasıl?
Layout'a bir kısa süreliğine görünen bir pencereyle olabilir. Mesajları göstermekk
için önce bir div alanı ekleyelim,

~$ vim app/views/layouts/application.html.erb
        <% flash.each do |key, value| %>
          <div class="flash <%= key %>"><%= value %></div>
        <% end %>

flash değişkeni nereden gelecek, tabii ki controller'dan gelecek,

~$ vim app/controllers/users_controller.rb
flash[:success] = "Welcome to the Sample App!"

eklendiğinde ve sign up formu başarılı doldurulduğunda yönlendirilen sayfada

        Welcome to the Sample App!

mesajı görülür.

# 7.4.3 The first signup


