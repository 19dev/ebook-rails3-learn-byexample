# Chapter 9: Updating, showing, and deleting users

## 9.1 Edit

Önce test,

~$ vim spec/requests/user_pages_spec.rb
describe "User pages" do
  describe "edit" do
    describe "page" do
      it {}
      it {}
      it {}
    end
    describe "with invalid information" do
      it {}
    end
  end
end

Başarısız olacağını biliyoruz, otomatik test edelim,

~$ bundle exec rspec spec/requests/user_pages_spec.rb -e "edit"
BAŞARISIZ (4 adet)

Spec dosyasında 4 adet it {} mevcut ve henüz gerçeklemeleri yapılmamış.
view:`edit` sayfasını oluşturalım.

~$ vim app/views/users/edit.html.erb
<% provide(:title, "Edit user") %>
<h1>Update your profile</h1>

<div class="row">
  <div class="span6 offset3">
  <%= form_for(@user) do |f| %>
      <%= render 'shared/error_messages', :object => f.object %>

      <%= f.label :name %>
      <%= f.text_field :name %>

      <%= f.label :email %>
      <%= f.text_field :email %>

      <%= f.label :password %>
      <%= f.password_field :password %>

      <%= f.label :password_confirmation, "Confirm Password" %>
      <%= f.password_field :password_confirmation %>

      <%= f.submit "Save changes", :class => "btn btn-large btn-primary" %>
    <% end %>

    <%= gravatar_for @user %>
    <a href="http://gravatar.com/emails">change</a>
  </div>
</div>

Tekrar teste alalım,

~$ bundle exec rspec spec/requests/user_pages_spec.rb -e "edit"
BAŞARISIZ (4 adet)

Değişmedi neden `visit edit_user_path(user)` diyoruz fakat buna dair controller
henüz hazır değil,

~$ vim app/controllers/users_controller.rb
  def edit
    @user = User.find(params[:id])
  end

Tekrar teste alalım,

~$ bundle exec rspec spec/requests/user_pages_spec.rb -e "edit"
BAŞARISIZ (1 adet)
~$ bundle exec rspec spec/requests/user_pages_spec.rb -e "edit page"
BAŞARILI

Kullanıcıya ayar (setting) sayfası imkanı vermek istiyoruz. Önce testini yazalım,

~$ vim spec/requests/authentication_pages_spec.rb
describe "Authentication" do
  describe "with invalid information" do
    let(:user) { FactoryGirl.create(:user) }
    before { sign_in user }

    it { should have_link('Settings', href: edit_user_path(user)) }

Daha öncesinde,

      before do
        fill_in "Email",    with: user.email
        fill_in "Password", with: user.password
        click_button "Sign in"
      end

olan kısım şimdi,

        before { sign_in user }

biçiminde fonksiyona dönüştürüldü. Bu fonksiyon nerede olacak? Daha önceden `full_title`
işlevini yazdığımız dosya,

~$ vim spec/support/utilities.rb
def sign_in(user)
  visit signin_path
  fill_in "Email",    with: user.email
  fill_in "Password", with: user.password
  click_button "Sign in"
  # Sign in when not using Capybara as well.
  cookies[:remember_token] = user.remember_token
end

Test geçersizdir,

~$ bundle exec rspec spec/requests/authentication_pages_spec.rb -e "with valid information"
BAŞARISIZ

Spec'i sağlamak için linki eklemeliyiz. Linki sign in'in de içerisinde olduğu dosyaya yazacağız,

~$ vim app/views/layouts/header.html.erb
<li><%= link_to "Settings", edit_user_path(current_user) %></li>

### 9.1.2 Unsuccessful edits

Eksik olan update yeteneği kazandıralım,

~$ vim app/controllers/users_controller.rb
  def update
    @user = User.find(params[:id])
    if @user.update_attributes(params[:user])
      # Handle a successful update.
    else
      render 'edit'
    end
  end

Teste alalım

~$ bundle exec rspec spec/
BAŞARILI

### 9.1.3 Successful edits

Testini ekleyelim,

~$ vim spec/requests/user_pages_spec.rb

describe "User pages" do
  ...
  describe "edit" do
    let(:user) { FactoryGirl.create(:user) }
    before { visit edit_user_path(user) }
    ...
    describe "with valid information" do
      let(:new_name)  { "New Name" }
      let(:new_email) { "new@example.com" }
      before do
        fill_in "Name",             with: new_name
        fill_in "Email",            with: new_email
        fill_in "Password",         with: user.password
        fill_in "Confirm Password", with: user.password
        click_button "Save changes"
      end

      it { should have_selector('title', text: new_name) }
      it { should have_selector('div.alert.alert-success') }
      it { should have_link('Sign out', :href => signout_path) }
      specify { user.reload.name.should  == new_name }
      specify { user.reload.email.should == new_email }
    end

Test başarısız,

~$ bundle exec rspec spec/requests/user_pages_spec.rb -e "with valid information"
BAŞARISIZ

Başarılı güncellemeyi idare edecek controller eklentisini yapalım,

~$ vim app/controllers/users_controller.rb
  def update
    @user = User.find(params[:id])
    if @user.update_attributes(params[:user])
      flash[:success] = "Profile updated"
      sign_in @user
      redirect_to @user
    else

Tekrar test edelim,

~$ bundle exec rspec spec/requests/user_pages_spec.rb -e "with valid information"
BAŞARISIZ(1)

## 9.2 Authorization
### 9.2.1  Requiring signed-in users
Önce testler

~$ vim spec/requests/authentication_pages_spec.rb
describe "Authentication" do
  ...
  describe "authorization" do
    describe "for non-signed-in users" do
      let(:user) { FactoryGirl.create(:user) }

      describe "in the Users controller" do
        describe "visiting the edit page" do
          before { visit edit_user_path(user) }
          it { should have_selector('title', text: 'Sign in') }
        end

        describe "submitting to the update action" do
          before { put user_path(user) }
          specify { response.should redirect_to(signin_path) }
        end
      end
    end
  end

Bazı sayfalara sadece login olunduktan sonra girilebilmeli ama nasıl?

~$ vim app/controllers/users_controller.rb
  before_filter :signed_in_user, only: [:edit, :update]
  ...
  private
    def signed_in_user
      redirect_to signin_path, notice: "Please sign in." unless signed_in?
    end

böylece edit ve update eylemleri login gerektirecek.

Buna dair spec'i de güncelleyelim,

~$ vim spec/requests/user_pages_spec.rb
describe "User pages" do
  describe "edit" do
    before do
      sign_in user
      visit edit_user_path(user)
    end

Teste alalım,

~$ bundle exec rspec spec/
BAŞARILI

###  Requiring the right user

Kullanıcı yalnızca kendi bilgilerini güncelleyebilmelidir,

~$ vim spec/requests/authentication_pages_spec.rb
describe "Authentication" do
  describe "authorization" do
    describe "as wrong user" do
      let(:user) { FactoryGirl.create(:user) }
      let(:wrong_user) { FactoryGirl.create(:user, email: "wrong@example.com") }
      before { sign_in user }

      describe "visiting Users#edit page" do
        before { visit edit_user_path(wrong_user) }
        it { should have_selector('title', text: full_title('')) }
      end

      describe "submitting a PUT request to the Users#update action" do
        before { put user_path(wrong_user) }
        specify { response.should redirect_to(root_path) }
      end
    end

controller'a bununla ilgili filtremizi ekleyelim

~$ vim app/controllers/users_controller.rb
before_filter :correct_user,   only: [:edit, :update]
  def edit
  end

  def update
    if @user.update_attributes(params[:user])
  .
  private
    def correct_user
      @user = User.find(params[:id])
      redirect_to(root_path) unless current_user?(@user)
    end

`current_user?` henüz tanımlanmadı,

~$ vim app/helper/sessions_helper.rb
  def current_user?(user)
    user == current_user
  end

teste alalım,

~$ bundle exec rspec spec/
BAŞARILI

### 9.2.3 Friendly forwarding

Düzenleme sayfasına girmek istenince login'e zorla, başarılı girişin ardından
düzenlemeye yönlendir,

~$ vim spec/requests/authentication_pages_spec.rb
describe "Authentication" do
  describe "authorization" do
    describe "for non-signed-in users" do
      let(:user) { FactoryGirl.create(:user) }

      describe "when attempting to visit a protected page" do
        before do
          visit edit_user_path(user)
          fill_in "Email",    with: user.email
          fill_in "Password", with: user.password
          click_button "Sign in"
        end

        describe "after signing in" do

          it "should render the desired protected page" do
            page.should have_selector('title', text: 'Edit user')
          end
        end
      end
    end

Gerçekleme zamanı,

~$ vim app/helper/sessions_helper.rb
  def redirect_back_or(default)
    redirect_to(session[:return_to] || default)
    clear_return_to
  end

  def store_location
    session[:return_to] = request.fullpath
  end

  private
    def clear_return_to
      session.delete(:return_to)
    end

store_location'unu giriş öncesine ekleyelim,

~$ vim app/controllers/users_controller.rb
    def signed_in_user
      unless signed_in?
        store_location
        redirect_to signin_path, notice: "Please sign in."
      end
    end

Oturum yönetimine de monte edelim,

~$ vim app/helper/sessions_helper.rb
def create
  ...
  redirect_back_or user

Teste alalım,

~$ bundle exec rspec spec/
BAŞARILI

## 9.3  Showing all users

