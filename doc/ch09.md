# Chapter 9: Updating, showing, and deleting users

## 9.1 Edit

Önce test,

~$ vim spec/requests/user_pages_spec.rb
describe "User pages" do
  describe "edit" do
    describe "page" do
      it {}
      it {}
      it {}
    end
    describe "with invalid information" do
      it {}
    end
  end
end

Başarısız olacağını biliyoruz, otomatik test edelim,

~$ bundle exec rspec spec/requests/user_pages_spec.rb -e "edit"
BAŞARISIZ (4 adet)

Spec dosyasında 4 adet it {} mevcut ve henüz gerçeklemeleri yapılmamış.
view:`edit` sayfasını oluşturalım.

~$ vim app/views/users/edit.html.erb
<% provide(:title, "Edit user") %>
<h1>Update your profile</h1>

<div class="row">
  <div class="span6 offset3">
  <%= form_for(@user) do |f| %>
      <%= render 'shared/error_messages', :object => f.object %>

      <%= f.label :name %>
      <%= f.text_field :name %>

      <%= f.label :email %>
      <%= f.text_field :email %>

      <%= f.label :password %>
      <%= f.password_field :password %>

      <%= f.label :password_confirmation, "Confirm Password" %>
      <%= f.password_field :password_confirmation %>

      <%= f.submit "Save changes", :class => "btn btn-large btn-primary" %>
    <% end %>

    <%= gravatar_for @user %>
    <a href="http://gravatar.com/emails">change</a>
  </div>
</div>

Tekrar teste alalım,

~$ bundle exec rspec spec/requests/user_pages_spec.rb -e "edit"
BAŞARISIZ (4 adet)

Değişmedi neden `visit edit_user_path(user)` diyoruz fakat buna dair controller
henüz hazır değil,

~$ vim app/controllers/users_controller.rb
  def edit
    @user = User.find(params[:id])
  end

Tekrar teste alalım,

~$ bundle exec rspec spec/requests/user_pages_spec.rb -e "edit"
BAŞARISIZ (1 adet)
~$ bundle exec rspec spec/requests/user_pages_spec.rb -e "edit page"
BAŞARILI

Kullanıcıya ayar (setting) sayfası imkanı vermek istiyoruz. Önce testini yazalım,

~$ vim spec/requests/authentication_pages_spec.rb
describe "Authentication" do
  describe "with invalid information" do
    let(:user) { FactoryGirl.create(:user) }
    before { sign_in user }

    it { should have_link('Settings', href: edit_user_path(user)) }

Daha öncesinde,

      before do
        fill_in "Email",    with: user.email
        fill_in "Password", with: user.password
        click_button "Sign in"
      end

olan kısım şimdi,

        before { sign_in user }

biçiminde fonksiyona dönüştürüldü. Bu fonksiyon nerede olacak? Daha önceden `full_title`
işlevini yazdığımız dosya,

~$ vim spec/support/utilities.rb
def sign_in(user)
  visit signin_path
  fill_in "Email",    with: user.email
  fill_in "Password", with: user.password
  click_button "Sign in"
  # Sign in when not using Capybara as well.
  cookies[:remember_token] = user.remember_token
end

Test geçersizdir,

~$ bundle exec rspec spec/requests/authentication_pages_spec.rb -e "with valid information"
BAŞARISIZ

Spec'i sağlamak için linki eklemeliyiz. Linki sign in'in de içerisinde olduğu dosyaya yazacağız,

~$ vim app/views/layouts/header.html.erb
<li><%= link_to "Settings", edit_user_path(current_user) %></li>

### 9.1.2 Unsuccessful edits

Eksik olan update yeteneği kazandıralım,

~$ vim app/controllers/users_controller.rb
  def update
    @user = User.find(params[:id])
    if @user.update_attributes(params[:user])
      # Handle a successful update.
    else
      render 'edit'
    end
  end

Teste alalım

~$ bundle exec rspec spec/
BAŞARILI



